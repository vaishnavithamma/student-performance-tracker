{% extends 'base.html' %}

{% block content %}

<h1>Students</h1>

<form method="get" class="row g-2 mb-4">
  <div class="col-auto">
    <input name="q" class="form-control" placeholder="Search by name or roll" value="{{ request.args.get('q','') }}">
  </div>
  <div class="col-auto">
    <select name="sort" class="form-select">
      <option value="name" {% if request.args.get('sort')=='name' %}selected{% endif %}>Sort: Name</option>
      <option value="avg" {% if request.args.get('sort')=='avg' %}selected{% endif %}>Sort: Average</option>
    </select>
  </div>
  <div class="col-auto">
    <button class="btn btn-secondary">Apply</button>
  </div>
</form>

{% if students %}
  <table class="table table-bordered bg-white">
    <thead>
      <tr>
        <th>Name</th>
        <th>Roll</th>
        <th>Average</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for s in students %}
      <tr>
        <td>{{ s.name }}</td>
        <td>{{ s.roll_number }}</td>
        <td>{{ s.average() if s.average() != None else '--' }}</td>
        <td>
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('student_detail', student_id=s.id) }}">View</a>
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('edit_student', student_id=s.id) }}">Edit</a>
          <form method="post" action="{{ url_for('delete_student', student_id=s.id) }}" style="display:inline-block;">
            <button class="btn btn-sm btn-danger" onclick="return confirm('Delete student?')">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h3 class="mt-4">Class Performance Chart</h3>
  <canvas id="classChart" height="90"></canvas>

{% else %}
  <p>No students yet. <a href="{{ url_for('add_student') }}">Add one</a>.</p>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
fetch("{{ url_for('class_stats') }}")
  .then(res => res.json())
  .then(data => {
    const labels = data.map(s => s.name);
    const scores = data.map(s => s.average);

    new Chart(document.getElementById('classChart'), {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Average Score',
          data: scores,
          backgroundColor: 'rgba(54, 162, 235, 0.7)',
        }]
      },
      options: {
        scales: { y: { beginAtZero: true, max: 100 } }
      }
    });
  });
</script>
{% endblock %}
