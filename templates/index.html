{% extends "base.html" %}
{% block content %}

<div class="page-title">Students</div>

<!-- Toolbar -->
<div class="card-panel d-flex flex-column flex-md-row align-items-start gap-3">
  <form method="get" class="d-flex flex-grow-1 gap-2 w-100">
    <input name="q" class="form-control" placeholder="Search by name or roll"
           value="{{ request.args.get('q','') }}">
    <select name="sort" class="form-select" style="max-width:220px;">
      <option value="name" {% if request.args.get('sort') != 'avg' %}selected{% endif %}>Sort: Name</option>
      <option value="avg" {% if request.args.get('sort') == 'avg' %}selected{% endif %}>Sort: Highest Average</option>
    </select>
    <button class="btn btn-primary">Apply</button>
    <div class="ms-auto d-flex gap-2">
      <a href="{{ url_for('add_student') }}" class="btn btn-primary">+ Add Student</a>
      <a href="{{ url_for('export_csv') }}" class="btn btn-outline-secondary">Export CSV</a>
    </div>
  </form>
</div>

<!-- Table card -->
<div class="card-panel">
  <div class="table-responsive">
    <table class="table table-borderless mb-0">
      <thead>
        <tr>
          <th>Name</th>
          <th>Roll</th>
          <th>Average</th>
          <th style="width:220px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for s in students %}
        <tr class="align-middle">
          <td>{{ s.name }}</td>
          <td>{{ s.roll_number }}</td>
          <td>{{ s.average() if s.average() is not none else '-' }}</td>
          <td>
            <a class="btn btn-outline-primary btn-sm me-1" href="{{ url_for('student_detail', student_id=s.id) }}">View</a>
            <a class="btn btn-outline-secondary btn-sm me-1" href="{{ url_for('edit_student', student_id=s.id) }}">Edit</a>

            <form method="post" action="{{ url_for('delete_student', student_id=s.id) }}" style="display:inline;">
              <button class="btn btn-danger btn-sm" onclick="return confirm('Delete this student?')">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Charts / stats -->
<div class="card-panel">
  <div class="d-flex flex-column flex-md-row gap-4">
    <div class="flex-fill">
      <h5 class="mb-3">Class Performance</h5>
      <div class="chart-card">
        <canvas id="classChart" height="120"></canvas>
      </div>
    </div>

    <div style="min-width:260px;">
      <h5 class="mb-3">Quick stats</h5>
      <div class="card-panel">
        <p class="mb-1"><strong>Total students:</strong> {{ students|length }}</p>
       <p class="mb-1"><strong>Average score (class):</strong>
  {% set avgs = [] %}
  {% for s in students %}
      {% if s.average() is not none %}
          {% set _ = avgs.append(s.average()) %}
      {% endif %}
  {% endfor %}

  {% if avgs %}
      {{ (avgs|sum / avgs|length) | round(2) }}
  {% else %}
      -
  {% endif %}
</p>


        <a href="{{ url_for('export_csv') }}" class="btn btn-outline-secondary mt-3">Download CSV</a>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
fetch("{{ url_for('class_stats') }}")
  .then(r => r.json())
  .then(data => {
    const names = data.map(d => d.name);
    const avgs = data.map(d => d.average);

    const ctx = document.getElementById('classChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: names,
        datasets: [{
          label: 'Average',
          data: avgs,
          borderRadius: 8,
          barThickness: 22
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, max: 100 }
        }
      }
    });
  });
</script>
{% endblock %}

{% endblock %}
